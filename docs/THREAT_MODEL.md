# Threat Model для SecAudit+

**Версия**: 1.0  
**Дата**: 2025-01-28  
**Методология**: STRIDE + DREAD

## Содержание

- [Обзор системы](#обзор-системы)
- [Границы доверия](#границы-доверия)
- [Анализ угроз (STRIDE)](#анализ-угроз-stride)
- [Оценка рисков (DREAD)](#оценка-рисков-dread)
- [Меры противодействия](#меры-противодействия)
- [Остаточные риски](#остаточные-риски)

---

## Обзор системы

SecAudit+ — инструмент аудита безопасности Linux-систем, который:
- Выполняет проверки безопасности на основе YAML-профилей
- Требует привилегированного доступа (root/sudo)
- Генерирует отчеты в различных форматах
- Интегрируется с CI/CD и системами мониторинга
- Может работать в контейнерах и Kubernetes

### Компоненты системы

1. **CLI Application** (`secaudit/main.py`)
2. **Audit Engine** (`modules/audit_runner.py`)
3. **Bash Executor** (`modules/bash_executor.py`)
4. **Profile Loader** (YAML parsing)
5. **Report Generator** (Jinja2 templates)
6. **Docker Container** (privileged mode)
7. **Kubernetes Deployment** (Helm chart)

---

## Границы доверия

### Trust Boundary 1: Профили аудита
- **Источник**: YAML-файлы в репозитории
- **Уровень доверия**: Высокий (контролируется разработчиками)
- **Риск**: Компрометация репозитория

### Trust Boundary 2: Система хоста
- **Источник**: Целевая Linux-система
- **Уровень доверия**: Средний (может быть скомпрометирована)
- **Риск**: Выполнение в скомпрометированной среде

### Trust Boundary 3: Пользовательский ввод
- **Источник**: CLI аргументы, переменные
- **Уровень доверия**: Низкий
- **Риск**: Injection атаки

### Trust Boundary 4: Внешние зависимости
- **Источник**: PyPI пакеты
- **Уровень доверия**: Средний
- **Риск**: Supply chain атаки

---

## Анализ угроз (STRIDE)

### S - Spoofing (Подмена идентификации)

#### T1: Подмена профилей аудита
- **Описание**: Злоумышленник подменяет YAML-профили вредоносными
- **Вектор атаки**: Компрометация репозитория или MitM при загрузке
- **Воздействие**: Выполнение произвольных команд с правами root
- **Вероятность**: Средняя
- **Меры**:
  - ✅ Проверка подписей Git commits
  - ❌ Подпись профилей (не реализовано)
  - ❌ Checksum validation (не реализовано)

#### T2: Подмена Docker образа
- **Описание**: Использование поддельного образа из GHCR
- **Вектор атаки**: Компрометация GitHub токена
- **Воздействие**: Выполнение вредоносного кода в инфраструктуре
- **Вероятность**: Низкая
- **Меры**:
  - ✅ SBOM generation
  - ✅ Trivy scanning
  - ❌ Image signing (не реализовано)

### T - Tampering (Изменение данных)

#### T3: Модификация результатов аудита
- **Описание**: Изменение отчетов для сокрытия проблем
- **Вектор атаки**: Доступ к файловой системе
- **Воздействие**: Ложное чувство безопасности
- **Вероятность**: Средняя
- **Меры**:
  - ❌ Подпись отчетов (не реализовано)
  - ❌ Immutable storage (не реализовано)
  - ✅ Централизованное хранение (Prometheus/Elastic)

#### T4: Модификация профилей во время выполнения
- **Описание**: Изменение YAML-профилей после валидации
- **Вектор атаки**: Race condition, TOCTOU
- **Воздействие**: Обход проверок безопасности
- **Вероятность**: Низкая
- **Меры**:
  - ✅ Валидация перед загрузкой
  - ❌ Runtime integrity checks (не реализовано)

### R - Repudiation (Отказ от действий)

#### T5: Отсутствие audit trail
- **Описание**: Невозможность доказать, кто запускал аудит
- **Вектор атаки**: Отсутствие логирования
- **Воздействие**: Невозможность расследования инцидентов
- **Вероятность**: Высокая
- **Меры**:
  - ✅ Логирование в файл
  - ❌ Централизованный audit log (не реализовано)
  - ❌ Подпись логов (не реализовано)

### I - Information Disclosure (Раскрытие информации)

#### T6: Утечка sensitive данных в отчетах
- **Описание**: Пароли, ключи в evidence файлах
- **Вектор атаки**: Сбор вывода команд
- **Воздействие**: Компрометация credentials
- **Вероятность**: Высокая
- **Меры**:
  - ❌ Фильтрация sensitive данных (не реализовано)
  - ❌ Encryption отчетов (не реализовано)
  - ⚠️ Ограничение доступа к results/

#### T7: Утечка через логи
- **Описание**: Sensitive данные в stdout/stderr
- **Вектор атаки**: Перехват логов
- **Воздействие**: Раскрытие конфигурации
- **Вероятность**: Средняя
- **Меры**:
  - ✅ Структурированное логирование
  - ❌ Redaction sensitive данных (не реализовано)

### D - Denial of Service (Отказ в обслуживании)

#### T8: Resource exhaustion
- **Описание**: Бесконечные циклы в профилях
- **Вектор атаки**: Вредоносный профиль
- **Воздействие**: Зависание системы
- **Вероятность**: Средняя
- **Меры**:
  - ✅ Timeout для команд
  - ✅ Resource limits в Kubernetes
  - ❌ Rate limiting (не реализовано)

#### T9: Disk space exhaustion
- **Описание**: Генерация огромных отчетов
- **Вектор атаки**: Профиль с большим evidence
- **Воздействие**: Заполнение диска
- **Вероятность**: Средняя
- **Меры**:
  - ✅ PVC limits в Kubernetes
  - ❌ Quota на размер отчетов (не реализовано)

### E - Elevation of Privilege (Повышение привилегий)

#### T10: Command injection
- **Описание**: Injection через переменные профиля
- **Вектор атаки**: Некорректная валидация input
- **Воздействие**: Выполнение произвольных команд
- **Вероятность**: Высокая
- **Меры**:
  - ⚠️ Частичная санитизация
  - ❌ Полная валидация переменных (не реализовано)
  - ✅ Jinja2 escaping

#### T11: Path traversal
- **Описание**: Доступ к файлам вне профилей
- **Вектор атаки**: ../../../etc/shadow в путях
- **Воздействие**: Чтение произвольных файлов
- **Вероятность**: Средняя
- **Меры**:
  - ✅ Санитизация имен файлов
  - ❌ Chroot/sandbox (не реализовано)

#### T12: Container escape
- **Описание**: Выход из контейнера на хост
- **Вектор атаки**: Privileged mode + уязвимости
- **Воздействие**: Компрометация хоста
- **Вероятность**: Низкая
- **Меры**:
  - ⚠️ Privileged mode необходим для аудита
  - ✅ Минимальный образ
  - ✅ Trivy scanning

---

## Оценка рисков (DREAD)

| ID | Угроза | D | R | E | A | D | Итого | Приоритет |
|----|--------|---|---|---|---|---|-------|-----------|
| T1 | Подмена профилей | 9 | 7 | 6 | 8 | 9 | 7.8 | Критический |
| T6 | Утечка sensitive данных | 8 | 9 | 8 | 7 | 8 | 8.0 | Критический |
| T10 | Command injection | 10 | 8 | 7 | 9 | 10 | 8.8 | Критический |
| T11 | Path traversal | 7 | 7 | 6 | 6 | 7 | 6.6 | Высокий |
| T5 | Отсутствие audit trail | 5 | 8 | 9 | 6 | 5 | 6.6 | Высокий |
| T8 | Resource exhaustion | 6 | 6 | 7 | 7 | 6 | 6.4 | Высокий |
| T3 | Модификация отчетов | 7 | 6 | 5 | 5 | 7 | 6.0 | Средний |
| T7 | Утечка через логи | 5 | 6 | 6 | 6 | 5 | 5.6 | Средний |
| T2 | Подмена Docker образа | 8 | 4 | 3 | 5 | 8 | 5.6 | Средний |
| T9 | Disk exhaustion | 4 | 5 | 6 | 6 | 4 | 5.0 | Средний |
| T4 | Модификация профилей | 6 | 3 | 4 | 4 | 6 | 4.6 | Низкий |
| T12 | Container escape | 9 | 2 | 2 | 3 | 9 | 5.0 | Средний |

**Легенда DREAD**:
- **D** (Damage) - Ущерб (1-10)
- **R** (Reproducibility) - Воспроизводимость (1-10)
- **E** (Exploitability) - Эксплуатируемость (1-10)
- **A** (Affected users) - Затронутые пользователи (1-10)
- **D** (Discoverability) - Обнаруживаемость (1-10)

---

## Меры противодействия

### Критический приоритет

#### 1. Command Injection Prevention (T10)
```python
# Реализовать whitelist валидацию переменных
ALLOWED_VAR_PATTERN = re.compile(r'^[A-Z0-9_]+$')
ALLOWED_VALUE_PATTERN = re.compile(r'^[a-zA-Z0-9\s\-_./]+$')

def validate_variable(key: str, value: str) -> bool:
    if not ALLOWED_VAR_PATTERN.match(key):
        raise ValueError(f"Invalid variable name: {key}")
    if not ALLOWED_VALUE_PATTERN.match(value):
        raise ValueError(f"Invalid variable value: {value}")
    return True
```

#### 2. Profile Signing (T1)
```yaml
# Добавить в профили
signature:
  algorithm: RSA-SHA256
  public_key: profiles/keys/secaudit.pub
  signature_file: profiles/base/linux.yml.sig
```

#### 3. Sensitive Data Filtering (T6)
```python
# Регулярные выражения для фильтрации
SENSITIVE_PATTERNS = [
    r'password["\s:=]+([^\s"]+)',
    r'token["\s:=]+([^\s"]+)',
    r'api[_-]?key["\s:=]+([^\s"]+)',
    r'secret["\s:=]+([^\s"]+)',
]

def redact_sensitive_data(text: str) -> str:
    for pattern in SENSITIVE_PATTERNS:
        text = re.sub(pattern, r'\1***REDACTED***', text, flags=re.IGNORECASE)
    return text
```

### Высокий приоритет

#### 4. Audit Trail (T5)
- Централизованное логирование в syslog/journald
- Подпись audit logs
- Immutable append-only storage

#### 5. Path Traversal Prevention (T11)
- Валидация всех путей к файлам
- Chroot для выполнения команд
- Whitelist разрешенных директорий

#### 6. Resource Limits (T8)
- Глобальный timeout для аудита
- Лимиты на количество параллельных проверок
- Memory limits для команд

### Средний приоритет

#### 7. Report Encryption (T3, T6)
- GPG encryption для отчетов
- Encrypted storage в Kubernetes
- TLS для передачи в Prometheus/Elastic

#### 8. Image Signing (T2)
- Cosign для подписи Docker образов
- Verification в Kubernetes admission controller

---

## Остаточные риски

### Принятые риски

1. **Privileged mode в Docker**
   - **Обоснование**: Необходим для системного аудита
   - **Митигация**: Минимальный образ, security scanning
   - **Владелец риска**: DevOps team

2. **Shell command execution**
   - **Обоснование**: Основная функциональность
   - **Митигация**: Timeout, валидация, sandboxing
   - **Владелец риска**: Development team

3. **Root privileges**
   - **Обоснование**: Требуется для большинства проверок
   - **Митигация**: Audit logging, RBAC
   - **Владелец риска**: Security team

### Требуют дополнительного анализа

1. Supply chain security для Python dependencies
2. Kubernetes RBAC policies
3. Network isolation в контейнерах
4. Secrets management для credentials

---

## Рекомендации

### Краткосрочные (1-2 спринта)
1. Реализовать валидацию переменных (T10)
2. Добавить фильтрацию sensitive данных (T6)
3. Внедрить централизованный audit trail (T5)

### Среднесрочные (квартал)
1. Подпись профилей и образов (T1, T2)
2. Encryption отчетов (T3, T6)
3. Sandboxing для команд (T10, T11)

### Долгосрочные (полугодие)
1. RBAC для multi-user deployments
2. Hardware security module (HSM) integration
3. Formal security audit от третьей стороны

---

**Последнее обновление**: 2025-01-28  
**Следующий пересмотр**: 2025-04-28  
**Владелец документа**: Security Team
